AWSTemplateFormatVersion: '2010-09-09'
Description: 'VPC with private subnets in two availability zones'
Parameters:
  PrivateSubnet:
    Description: Private Subnet to Attach NAT Gateway.
    Type: AWS::EC2::Subnet::Id
    Default: 'subnet-08afb76ea37f066b5'

  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: c5.xlarge
    AllowedValues: [t2.micro, c5.xlarge]
    ConstraintDescription: Please choose a valid instance type.

  SSHKeyName:
    Description: EC2 instance type 
    Type: String
    Default: 'CloudFormation'
    ConstraintDescription: Please choose a valid KeyName

  ImageId:
    Type: String
    Description: 'value for region singapore. If you using other version please choose right'
    Default: 'ami-0870317655f5daccb'
    
  SecurityGroupIds:
    Description: launch-wizard3
    Type: AWS::EC2::SecurityGroup::Id
    Default: 'sg-07ea85405a716eee4'
    
  AvailabilityZone:
    Description: 1b 
    Type: AWS::EC2::AvailabilityZone::Name
    Default: 'ap-southeast-1b'
       
Resources:
  EC2Example:
    Type: "AWS::EC2::Instance"
    Metadata:
      AWS::CloudFormation::Init:
        services:
          sysvint:
            codedeploy-agent:
              enabled: 'true'
              ensureRunning: 'true'
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      KeyName: !Ref SSHKeyName
      IamInstanceProfile: "EC2CodeDeploy"
      NetworkInterfaces: 
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - Ref: "SecurityGroupIds"
          SubnetId: 
            Ref: "PrivateSubnet"       
      Tags:
      - Key: 'MISPCF'
        Value: 'MISPCFInstance'
 
 #Point to existing static IP (Elastic IP)#
  AssociateControlPort:
    Type: AWS::EC2::EIPAssociation
    Properties:
    #Allocation ID located at EC2 -> Elastic IP #
      AllocationId: 'eipalloc-0eec026687d4d361c'
      
      InstanceId: !Ref EC2Example        
